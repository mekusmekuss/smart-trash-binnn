<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Garbage Bottle Counter</title>
<style>
  body{margin:0;font-family:Arial,sans-serif;background:#111;color:#fff;text-align:center;padding:20px;}
  h2{margin-bottom:10px;}
  #video{width:260px;height:420px;background:#000;border:2px solid #fff;border-radius:12px;object-fit:cover;margin:0 auto 12px;display:block;}
  #counter{display:inline-block;background:#fff;color:#000;padding:10px 16px;border-radius:10px;font-weight:700;margin-top:6px;}
  #msg{margin-top:12px;min-height:44px;white-space:pre-line;line-height:1.3;}
  #peso{margin-top:12px;font-size:22px;font-weight:bold;color:#00e676;}
  .controls{margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  button{padding:10px 14px;font-size:15px;border-radius:8px;border:none;cursor:pointer;font-weight:600;}
  .btn-claim{background:#00e676;color:#05221a;}
  .btn-reset{background:#ff1744;color:white;}
</style>
</head>
<body>
<h2>Smart Trash Bottle Counter ‚ôªÔ∏è</h2>
<video id="video" autoplay playsinline muted></video>
<div id="counter">Bottles: <span id="count">0</span></div>
<div id="peso">‚Ç±0</div>
<div id="msg">Initializing camera‚Ä¶</div>
<div class="controls">
  <button class="btn-claim" id="claimBtn">Show Peso üí∞</button>
  <button class="btn-reset" id="resetBtn">Reset</button>
</div>

<script>
let count=0,lastCountTime=0;
const video=document.getElementById('video');
const countDisplay=document.getElementById('count');
const msg=document.getElementById('msg');
const pesoDisplay=document.getElementById('peso');

function setMsg(text,color){msg.style.color=color||'#fff';msg.textContent=text;}
function manualReset(){count=0;countDisplay.textContent=count;pesoDisplay.textContent='‚Ç±0';setMsg('Counter reset ‚úî','#64ffda');}
function resetIfNoMotion(){clearTimeout(window.noMotionReset);window.noMotionReset=setTimeout(()=>{count=0;countDisplay.textContent=count;pesoDisplay.textContent='‚Ç±0';setMsg('No motion 5 mins ‚Üí Auto reset','orange');},5*60*1000);}
function detectMotion(){
  const w=video.videoWidth,h=video.videoHeight;
  if(!w||!h){requestAnimationFrame(detectMotion);return;}
  const canvas=document.createElement('canvas');
  canvas.width=Math.round(w/2);
  canvas.height=Math.round(h/2);
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const cropX=Math.round(canvas.width*0.25);
  const cropY=Math.round(canvas.height*0.35);
  const cropW=Math.max(1,Math.round(canvas.width*0.5));
  const cropH=Math.max(1,Math.round(canvas.height*0.3));
  ctx.filter='blur(4px)';
  const frame=ctx.getImageData(cropX,cropY,cropW,cropH);
  ctx.filter='none';
  if(!window.prevFrame){window.prevFrame=frame;resetIfNoMotion();requestAnimationFrame(detectMotion);return;}
  const prev=window.prevFrame.data,curr=frame.data;
  let motionScore=0;
  for(let i=0;i<curr.length;i+=12){
    const diff=Math.abs(curr[i]-prev[i])+Math.abs(curr[i+1]-prev[i+1])+Math.abs(curr[i+2]-prev[i+2]);
    if(diff>85) motionScore++;
  }
  const now=Date.now();
  if(motionScore>500&&now-lastCountTime>1200){count++;countDisplay.textContent=count;lastCountTime=now;setMsg('Bottle detected ‚úÖ','#00e676');resetIfNoMotion();}
  window.prevFrame=frame;
  requestAnimationFrame(detectMotion);
}

(async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject=stream;await video.play();setMsg('Camera started ‚úî','#64ffda');detectMotion();
  }catch(err){setMsg('Camera failed. Allow permission!','orange');}
})();

document.getElementById('claimBtn').addEventListener('click',()=>{
  pesoDisplay.textContent='‚Ç±'+count;
  setMsg('Peso calculated','#00e676');
});
document.getElementById('resetBtn').addEventListener('click',manualReset);
</script>
</body>
</html>
