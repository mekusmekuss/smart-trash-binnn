<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Trash Bin ‚Äî Counter & Coupons (With Receipt)</title>

<!-- QR lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  :root{
    --bg: #e9f0f6;
    --card: #fff;
    --muted:#5b6b78;
    --accent: #0a4d7c;
    --accent-2: #0b6ba7;
    --danger: #d64545;
    --glass: rgba(255,255,255,0.6);
  }
  [data-theme="dark"]{
    --bg: #0f1720;
    --card: #0b1220;
    --muted: #aeb7c0;
    --accent: #4fb3ff;
    --accent-2: #2ea6ff;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  body{background: linear-gradient(180deg,var(--bg), #f6fbff);color: #0d1720;padding:18px;}
  .wrap{max-width:1100px;margin:8px auto;display:grid;grid-template-columns:560px 1fr;gap:18px;align-items:start;}
  @media (max-width:980px){.wrap{grid-template-columns:1fr;padding:0 12px}}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{background:linear-gradient(135deg,var(--accent),var(--accent-2));width:48px;height:48px;border-radius:12px;color:white;display:flex;align-items:center;justify-content:center;font-weight:700}
  h1{font-size:18px;margin:0}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 26px rgba(2,6,23,0.06);border:1px solid rgba(0,0,0,0.04)}

  /* left column (camera) */
  #cameraCard{display:flex;flex-direction:column;gap:10px;align-items:center}
  video#video{width:520px;height:360px;background:#000;border-radius:10px;object-fit:cover;border:2px solid rgba(0,0,0,0.06)}
  .counter{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .counter .pill{background:linear-gradient(90deg,#fff,#f3f7fb);padding:10px 14px;border-radius:10px;font-weight:800;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
  #msg{min-height:38px;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:white}
  .btn-danger{background:var(--danger);color:white}
  .btn-muted{background:transparent;border:1px solid rgba(0,0,0,0.06)}

  /* right column */
  .form-row{display:flex;gap:8px}
  label{display:block;font-weight:700;margin-top:8px;font-size:13px}
  input, select {width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);margin-top:6px}
  #photoPreview{width:100%;max-height:240px;border-radius:8px;object-fit:cover;display:none;margin-top:8px}
  .coupon-area{display:flex;flex-direction:column;gap:12px}
  .coupon-card{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.95),var(--glass));border:1px solid rgba(0,0,0,0.04)}
  #qrcode{margin:10px auto}
  .history{max-height:320px;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:8px}
  .history-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)}
  .small{font-size:13px;color:var(--muted)}
  .muted{font-size:13px;color:var(--muted);margin-top:6px}
  .top-controls{display:flex;gap:8px;align-items:center}
  .cooldown{font-size:13px;color:var(--muted)}
</style>
</head>

<body data-theme="light">
<div class="wrap">

<header>
  <div class="brand">
    <div class="logo">‚ôªÔ∏è</div>
    <div>
      <h1>Smart Trash Bin ‚Äî Counter & Coupons</h1>
      <div class="small">Camera motion detector ‚Üí bottle counting ‚Üí generate QR coupon</div>
    </div>
  </div>

  <div class="top-controls">
    <button id="themeToggle" class="btn-muted">üåô Dark</button>
    <button id="firebaseToggle" class="btn-muted" title="Toggle Firebase (UI only)">‚òÅÔ∏è Firebase (off)</button>
  </div>
</header>

<!-- LEFT: Camera + Counter -->
<section class="card" id="cameraCard">
  <div style="display:flex;justify-content:space-between;width:100%;align-items:center">
    <strong>Camera ‚Äî Motion Detector</strong>
    <div class="cooldown" id="cdText">Ready</div>
  </div>

  <video id="video" autoplay playsinline muted></video>

  <div class="counter" style="width:100%;justify-content:center">
    <div class="pill">Bottles: <span id="count">0</span></div>
    <div class="pill">Peso est.: <span id="peso">‚Ç±0</span></div>
    <div class="pill small" id="detectionInfo">Idle</div>
  </div>

  <div id="msg" class="small">Initializing camera‚Ä¶</div>

  <div class="controls" style="margin-top:8px">
    <button id="autoCaptureToggle" class="btn-muted">ü§ñ Auto-capture on detection: OFF</button>
    <button id="capturePhoto" class="btn-primary">üì∏ Capture Photo</button>
    <button id="claimBtn" class="btn-primary">Show Peso</button>
    <button id="resetBtn" class="btn-danger">Reset</button>
  </div>
</section>

<!-- RIGHT PANEL -->
<aside>
  <div class="card coupon-area">

    <!-- FORM -->
    <div class="coupon-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Submit & Get Coupon</strong>
        <small class="small">Ready</small>
      </div>

      <div style="margin-top:8px">
        <label>Your Name</label>
        <input id="name" type="text" placeholder="Juan dela Cruz">

        <label>Type of Trash</label>
        <select id="trashType">
          <option>Plastic Bottle</option>
          <option>Glass Bottle</option>
          <option>Aluminum Can</option>
          <option>Paper</option>
          <option>Other</option>
        </select>

        <div class="form-row">
          <div style="flex:1">
            <label>Quantity</label>
            <input id="quantity" type="number" min="1" value="1">
          </div>
          <div style="width:120px">
            <label>Points / item</label>
            <input id="pointsPer" type="number" min="1" value="5">
          </div>
        </div>

        <label>Proof photo (optional)</label>
        <input id="photo" type="file" accept="image/*" capture="environment">
        <img id="photoPreview" alt="Proof preview">

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="submitBtn" class="btn-primary">Submit & Generate Coupon</button>
          <button id="useCaptureBtn" class="btn-muted">Use Last Capture</button>
        </div>
      </div>
    </div>

    <!-- COUPON DISPLAY -->
    <div class="card" style="padding:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Coupon</strong>
        <div style="display:flex;gap:8px">
          <button id="copyLast" class="btn-muted">Copy</button>
          <button id="downloadQRCode" class="btn-muted">Download QR</button>
        </div>
      </div>

      <div class="coupon-card" style="margin-top:10px">
        <div id="qrcode"></div>
        <div id="couponDetails" class="small muted">No coupon yet. Submit the form to generate.</div>
      </div>
    </div>

    <!-- RECEIPT PANEL -->
    <div class="card" style="padding:12px; margin-top:12px">
      <strong>Receipt</strong>
      <div id="receiptBox" class="small muted" style="margin-top:10px">
        No receipt generated yet.
      </div>

      <div style="margin-top:10px; display:flex; gap:8px">
        <button id="printReceipt" class="btn-muted">üñ®Ô∏è Print</button>
        <button id="downloadReceipt" class="btn-muted">‚¨áÔ∏è PDF</button>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="card" style="padding:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>History</strong>
        <div style="display:flex;gap:8px">
          <button id="exportCSV" class="btn-muted">‚¨áÔ∏è CSV</button>
          <button id="clearAll" class="btn-danger">Clear</button>
        </div>
      </div>
      <div class="history" id="historyList"></div>
      <div class="muted">Note: Data saved locally.</div>
    </div>

  </div>
</aside>

</div>

<script>
/* ---------------- Utilities ---------------- */
function el(id){return document.getElementById(id)}
function randCode(len=9){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:len},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}
function isoDateDaysFromNow(days){
  const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().split('T')[0];
}
function saveLocal(arr){ localStorage.setItem('smartTrash_coupons', JSON.stringify(arr)); }
function loadLocal(){ try { return JSON.parse(localStorage.getItem('smartTrash_coupons')||'[]'); } catch(e){ return []; } }

/* ---------------- UI refs ---------------- */
const video = el('video');
const countEl = el('count');
const pesoEl = el('peso');
const msgEl = el('msg');
const cdText = el('cdText');
const detectionInfo = el('detectionInfo');

const autoCaptureToggle = el('autoCaptureToggle');
const capturePhotoBtn = el('capturePhoto');
const claimBtn = el('claimBtn');
const resetBtn = el('resetBtn');

const photoInput = el('photo');
const previewImg = el('photoPreview');
const useCaptureBtn = el('useCaptureBtn');
const submitBtn = el('submitBtn');

const qrcodeContainer = el('qrcode');
const couponDetails = el('couponDetails');
const exportCSV = el('exportCSV');
const clearAll = el('clearAll');
const historyList = el('historyList');
const copyLast = el('copyLast');
const downloadQRCode = el('downloadQRCode');

const themeToggle = el('themeToggle');
const firebaseToggle = el('firebaseToggle');

let FIREBASE_ENABLED = false;

/* ---------------- Motion Detector & Counter ---------------- */
let count = 0;
let lastCountTime = 0;
let lastFrame = 0;
let prevFrame = null;
let autoCapture = false;
let lastCaptureDataUrl = '';
let noMotionTimer = null;
const COOLDOWN_MS = 1200;
const FPS_INTERVAL = 80;
const MOTION_THRESHOLD_PIXEL_DIFF = 140;
const MOTION_THRESHOLD_SCORE = 2200;

function setMsg(text, color){ msgEl.style.color = color||'var(--muted)'; msgEl.textContent = text; }
function updatePeso(){ pesoEl.textContent = '‚Ç±' + count; }
function manualReset(){ count = 0; lastCountTime = 0; countEl.textContent = count; updatePeso(); setMsg('Counter reset ‚úî', '#0a8'); }
function resetIfNoMotion(){ clearTimeout(noMotionTimer); noMotionTimer = setTimeout(()=>{ setMsg('No motion ‚Äî auto reset', 'orange'); manualReset(); stopCamera(); }, 5*60*1000); }

function handleBottleDetected(){
  const now = Date.now();
  if(now - lastCountTime < COOLDOWN_MS) return;
  lastCountTime = now;
  count++;
  countEl.textContent = count;
  updatePeso();
  setMsg('Bottle detected ‚úÖ', '#00e676');
  detectionInfo.textContent = 'Detected: ' + new Date().toLocaleTimeString();
  if(autoCapture) captureSnapshot();
  resetIfNoMotion();
  playBeep();
}

function captureSnapshot(){
  try {
    const w = video.videoWidth, h = video.videoHeight;
    if(!w||!h) return '';
    const canvas = document.createElement('canvas');
    const scale = 0.6;
    canvas.width = Math.round(w * scale);
    canvas.height = Math.round(h * scale);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const data = canvas.toDataURL('image/jpeg', 0.7);
    lastCaptureDataUrl = data;
    previewImg.src = data;
    previewImg.style.display = 'block';
    return data;
  } catch(e){
    return '';
  }
}

function detectMotion(timestamp){
  requestAnimationFrame(detectMotion);
  if(!video || video.readyState < 2) return;
  if(timestamp - lastFrame < FPS_INTERVAL) return;
  lastFrame = timestamp;

  const w = video.videoWidth, h = video.videoHeight;
  if(!w || !h) return;

  const canvas = document.createElement('canvas');
  canvas.width = Math.round(w/2);
  canvas.height = Math.round(h/2);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const cropX = Math.round(canvas.width * 0.25);
  const cropY = Math.round(canvas.height * 0.2);
  const cropW = Math.round(canvas.width * 0.5);
  const cropH = Math.round(canvas.height * 0.5);

  let frame;
  try { frame = ctx.getImageData(cropX, cropY, cropW, cropH); }
  catch(e){ return; }

  if(!prevFrame){ prevFrame = frame; resetIfNoMotion(); return; }

  const prev = prevFrame.data;
  const curr = frame.data;
  let motionScore = 0;

  for(let i=0;i<curr.length;i+=12){
    const diff =
      Math.abs(curr[i]-prev[i]) +
      Math.abs(curr[i+1]-prev[i+1]) +
      Math.abs(curr[i+2]-prev[i+2]);

    if(diff > MOTION_THRESHOLD_PIXEL_DIFF) motionScore++;
  }

  const since = Date.now() - lastCountTime;
  cdText.textContent = (since < COOLDOWN_MS)
    ? ('Cooldown ' + Math.ceil((COOLDOWN_MS - since)/100)/10 + 's')
    : 'Ready';

  if(motionScore > MOTION_THRESHOLD_SCORE) handleBottleDetected();
  prevFrame = frame;
}

/* ---------------- Camera ---------------- */
let streamRef = null;

async function startCamera(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment', width:{ideal:1280}, height:{ideal:720}},
      audio:false
    });
    streamRef = s;
    video.srcObject = s;
    await video.play();
    setMsg('Camera started ‚úî', '#0a8');
    requestAnimationFrame(detectMotion);
    resetIfNoMotion();
  }catch(err){
    setMsg('Camera failed ‚Äî allow permission', 'orange');
  }
}

function stopCamera(){
  if(streamRef){
    streamRef.getTracks().forEach(t=>t.stop());
    streamRef = null;
    setMsg('Camera stopped', '#aab');
  }
}

/* ---------------- Audio ---------------- */
const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
function playBeep(){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.value = 860;
  g.gain.value = 0.02;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  setTimeout(()=> o.stop(), 80);
}

/* ---------------- Coupon Logic ---------------- */
function getRedeemURL(code){
  const base = location.origin + location.pathname;
  return base + '?redeem=1&code=' + encodeURIComponent(code);
}

function renderCouponUI(c){
  couponDetails.innerHTML = `
    <strong>${c.rewardValue}</strong><br>
    <span class="small">Name: ${c.name}</span><br>
    <span class="small">Type: ${c.trashType} ¬∑ Qty: ${c.qty}</span><br>
    <span class="small">Expiry: ${c.expiry}</span>
  `;

  qrcodeContainer.innerHTML = '';
  new QRCode(qrcodeContainer, {text: c.payload, width:160, height:160});
}

/* ---------------- RECEIPT SYSTEM ---------------- */
function renderReceipt(c){
  const box = el('receiptBox');
  box.innerHTML = `
    <h3 style="margin:0 0 6px 0">‚ôªÔ∏è Smart Trash Bin Receipt</h3>
    <div><strong>Name:</strong> ${c.name}</div>
    <div><strong>Trash Type:</strong> ${c.trashType}</div>
    <div><strong>Quantity:</strong> ${c.qty}</div>
    <div><strong>Points/Item:</strong> ${c.pointsPer}</div>
    <div><strong>Total Points:</strong> ${c.rewardValue}</div>
    <div><strong>Coupon Code:</strong> ${c.id}</div>
    <div><strong>Date:</strong> ${new Date(c.createdAt).toLocaleString()}</div>
    <div><strong>Expires:</strong> ${c.expiry}</div>
    <hr>
    <div style="font-size:12px;color:var(--muted)">
      This receipt is automatically generated upon coupon creation.
    </div>
  `;
}

/* PRINT RECEIPT */
el("printReceipt").addEventListener("click", () => {
  const receipt = el("receiptBox").innerHTML;
  const w = window.open("", "PRINT", "height=600,width=800");
  w.document.write(`<html><head><title>Receipt</title></head><body>${receipt}</body></html>`);
  w.document.close(); w.focus();
  w.print(); w.close();
});

/* DOWNLOAD RECEIPT */
el("downloadReceipt").addEventListener("click", () => {
  const receipt = el("receiptBox").innerHTML;
  const blob = new Blob([receipt], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "receipt.html";
  a.click();
  URL.revokeObjectURL(url);
});

/* ---------------- Create coupon ---------------- */
async function createCouponData({name, trashType, qty, pointsPer, photoData}){
  const code = randCode(9);
  const createdAt = new Date().toISOString();
  const expiry = isoDateDaysFromNow(30);
  const rewardValue = `${qty * pointsPer} eco points`;
  const payload = getRedeemURL(code);

  const c = { id:code, name, trashType, qty, pointsPer, rewardValue, createdAt, expiry,
              payload, photoData, redeemed:false };

  const list = loadLocal();
  list.unshift(c);
  saveLocal(list);

  renderCouponUI(c);
  renderHistory();
  renderReceipt(c);   // AUTO RECEIPT GENERATION

  return c;
}

/* Intercept to track last coupon */
let lastGeneratedCoupon = null;
const orig = createCouponData;
createCouponData = async (opts)=> {
  const c = await orig(opts);
  lastGeneratedCoupon = c;
  return c;
};

/* ---------------- History ---------------- */
function renderHistory(){
  const arr = loadLocal();
  historyList.innerHTML = '';

  if(arr.length===0){
    historyList.innerHTML = '<div class="small muted">No coupons yet.</div>';
    return;
  }

  arr.forEach((it,idx)=>{
    const div = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = `
      <div>
        <strong>${it.name}</strong><br>
        <span class="small">${it.trashType}</span><br>
        <span class="small">${it.id}</span>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn-muted" data-idx="${idx}" data-act="view">View</button>
        <button class="btn-muted" data-idx="${idx}" data-act="redeem">Redeem</button>
        <button class="btn-danger" data-idx="${idx}" data-act="del">Delete</button>
      </div>
    `;
    historyList.appendChild(div);
  });

  historyList.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const act = btn.dataset.act;
      const idx = Number(btn.dataset.idx);
      const arr = loadLocal();
      const item = arr[idx];

      if(act==='view'){ renderCouponUI(item); renderReceipt(item); }
      else if(act==='del'){ arr.splice(idx,1); saveLocal(arr); renderHistory(); }
      else if(act==='redeem'){ window.open(getRedeemURL(item.id),'_blank'); }
    });
  });
}

/* ---------------- CSV Export ---------------- */
exportCSV.addEventListener('click', ()=>{
  const arr = loadLocal();
  if(!arr.length) return alert("No coupons to export");

  const rows = [['code','name','type','qty','pointsPer','reward','expiry','createdAt']];
  arr.forEach(r=> rows.push([r.id,r.name,r.trashType,r.qty,r.pointsPer,r.rewardValue,r.expiry,r.createdAt]));
  const csv = rows.map(r=> r.join(',')).join('\n');

  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'coupons.csv'; a.click();
  URL.revokeObjectURL(url);
});

/* ---------------- Clear All ---------------- */
clearAll.addEventListener('click', ()=>{
  if(confirm("Clear all coupons?")){
    localStorage.removeItem('smartTrash_coupons');
    renderHistory();
  }
});

/* ---------------- Photo handling ---------------- */
photoInput.addEventListener('change',(e)=>{
  const f = e.target.files?.[0];
  if(!f){ previewImg.style.display='none'; return; }
  const r = new FileReader();
  r.onload = ()=>{ previewImg.src = r.result; previewImg.style.display='block'; lastCaptureDataUrl = r.result; }
  r.readAsDataURL(f);
});
useCaptureBtn.addEventListener('click',()=>{
  if(!lastCaptureDataUrl) return alert("No captured image");
  previewImg.src = lastCaptureDataUrl;
  previewImg.style.display='block';
});

/* ---------------- Form submit ---------------- */
submitBtn.addEventListener('click', async ()=>{
  const name = el('name').value || 'Anonymous';
  const trashType = el('trashType').value;
  const qty = Math.max(1, Number(el('quantity').value));
  const pointsPer = Math.max(1, Number(el('pointsPer').value));
  const photoData = previewImg.src || lastCaptureDataUrl || '';

  const c = await createCouponData({name, trashType, qty, pointsPer, photoData});
  alert("Coupon created: " + c.id);

  el('quantity').value = 1;
  previewImg.style.display='none';
});

/* ---------------- QR actions ---------------- */
copyLast.addEventListener('click',()=>{
  if(!lastGeneratedCoupon) return alert("No coupon");
  navigator.clipboard.writeText(lastGeneratedCoupon.id);
  alert("Copied!");
});

downloadQRCode.addEventListener('click',()=>{
  const q = qrcodeContainer.querySelector('img') || qrcodeContainer.querySelector('canvas');
  if(!q) return;
  const data = q.tagName === 'IMG' ? q.src : q.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = data; a.download = 'qrcode.png'; a.click();
});

/* ---------------- Counter buttons ---------------- */
autoCaptureToggle.addEventListener('click',()=>{
  autoCapture = !autoCapture;
  autoCaptureToggle.textContent = autoCapture
    ? "ü§ñ Auto-capture: ON"
    : "ü§ñ Auto-capture: OFF";
});
capturePhotoBtn.addEventListener('click',()=>{ captureSnapshot(); alert("Captured."); });
claimBtn.addEventListener('click',()=>{ updatePeso(); setMsg("Peso updated","#0a8"); });
resetBtn.addEventListener('click', manualReset);

/* ---------------- Theme toggle ---------------- */
themeToggle.addEventListener('click',()=>{
  const cur = document.body.getAttribute("data-theme") || "light";
  const next = cur === "light" ? "dark" : "light";
  document.body.setAttribute("data-theme",next);
  themeToggle.textContent = next === "dark" ? "‚òÄÔ∏è Light" : "üåô Dark";
});

/* ---------------- Init ---------------- */
(async function init(){
  renderHistory();
  startCamera();

  // continuous cooldown display
  (function loop(){
    const since = Date.now() - lastCountTime;
    cdText.textContent = (since < COOLDOWN_MS)
      ? ("Cooldown " + Math.ceil((COOLDOWN_MS - since)/100)/10 + "s")
      : "Ready";
    requestAnimationFrame(loop);
  })();
})();
</script>

</body>
</html>
